(async () => {
    console.log("â³ æ­£åœ¨è‡ªåŠ¨æ»šåŠ¨é¡µé¢åŠ è½½æ‰€æœ‰å†…å®¹ï¼Œè¯·ç¨å€™...");

    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿åŠ è½½å®Œæ•´
    let lastHeight = 0;
    let sameCount = 0;

    while (sameCount < 5) { // å¦‚æœ5æ¬¡æ£€æµ‹åˆ°é¡µé¢é«˜åº¦ä¸å˜ï¼Œåˆ¤å®šæ»šåŠ¨å®Œæˆ
        window.scrollTo(0, document.body.scrollHeight);
        await new Promise(resolve => setTimeout(resolve, 1000)); // æ¯æ¬¡æ»šåŠ¨åç­‰1ç§’

        let newHeight = document.body.scrollHeight;
        if (newHeight === lastHeight) {
            sameCount++;
        } else {
            sameCount = 0;
            lastHeight = newHeight;
        }
    }

    console.log("âœ… é¡µé¢æ»šåŠ¨å®Œæˆï¼Œå¼€å§‹æå–å¯¹è¯å†…å®¹...");

    // å¼€å§‹æå–
    let blocks = document.querySelectorAll('div.relative');
    let textContent = "";

    blocks.forEach((block, idx) => {
        let role = "Unknown";
        let content = "";

        if (block.querySelector('.text-token-text-primary') || block.querySelector('div.items-end')) {
            role = "User";
            let userContent = block.querySelector('.text-token-text-primary') || block.querySelector('div.items-end');
            if (userContent) {
                content = userContent.innerText.trim();
            }
        } else if (block.querySelector('.markdown') || block.querySelector('.prose')) {
            role = "ChatGPT";
            let assistantContent = block.querySelector('.markdown, .prose');
            if (assistantContent) {
                content = assistantContent.innerText.trim();
            }
        }

        if (content) {
            const timestamp = new Date().toLocaleString();
            textContent += `# ${role} Message ${idx + 1}\n`;
            textContent += `[Time]: ${timestamp}\n`;
            textContent += `[${role}]:\n${content}\n\n====================\n\n`;
        }
    });

    // å°è¯•è¯»å–å¯¹è¯æ ‡é¢˜
    let titleElement = document.querySelector('nav a.bg-token-surface-secondary, nav a.bg-gray-200');
    let title = titleElement ? titleElement.innerText.trim() : '';

    if (!title) {
        title = prompt('âš ï¸ æ²¡æ‰¾åˆ°å¯¹è¯æ ‡é¢˜ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ–‡ä»¶å:', 'ChatGPT_Conversation');
        if (!title) {
            title = `ChatGPT_Conversation_${Date.now()}`;
        }
    }

    title = title.replace(/[\\\/:*?"<>|]/g, '');

    // ä¸‹è½½æ–‡ä»¶
    const blob = new Blob([textContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title}.txt`;
    a.click();
    URL.revokeObjectURL(url);

    console.log("ğŸ‰ å¯¹è¯æå–å®Œæˆå¹¶ä¸‹è½½æˆåŠŸï¼");
})();
